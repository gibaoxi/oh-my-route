name: daili

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  test-proxies:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      working-directory: ./daili
      run: |
        pip install --upgrade pip
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        else
          pip install requests urllib3
        fi
        
    - name: Run proxy test
      working-directory: ./daili
      run: |
        python daili.py
        
    - name: Commit and push results
      run: |
        echo "ğŸ’¾ å¼€å§‹æäº¤æ›´æ”¹..."
        
        # é…ç½®Git
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global pull.rebase true
        
        # å…ˆæ‹‰å–æœ€æ–°æ›´æ”¹
        echo "ğŸ“¥ æ‹‰å–è¿œç¨‹æœ€æ–°æ›´æ”¹..."
        git pull origin main
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        echo "ğŸ” æ£€æŸ¥æ›´æ”¹..."
        git status
        
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add -A
        
        # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„æ›´æ”¹
        if git diff-index --quiet HEAD --; then
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
        else
          # æäº¤æ›´æ”¹
          echo "ğŸ“ æäº¤æ›´æ”¹..."
          git commit -m "ğŸ¤– Auto update proxy results - $(date +'%Y-%m-%d %H:%M:%S')"
          
          # æ¨é€æ›´æ”¹
          echo "ğŸ“¤ æ¨é€æ›´æ”¹..."
          git push origin main
          echo "âœ… æ›´æ”¹å·²æˆåŠŸæ¨é€"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
